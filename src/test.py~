'''
Created on 3 Jun 2014

@author: samgeen
'''

import vhone
import numpy as np

import pyglet
from pyglet.gl import *


class Integrator(object):
    def __init__(self):
        self._glPoints = None
        self._window = pyglet.window.Window(512,512)
        self._window._integrator = self
        self._mx = 0.5
        self._my = 0.5
        self._step = False
        
    def Setup(self):

        @self._window.event
        def on_draw():
            glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT)
            
            glDisable(GL_DEPTH_TEST)
            glLoadIdentity()
            glViewport(0, 0, self._window.width, self._window.height)
            glMatrixMode(GL_PROJECTION)
            glLoadIdentity()
            glOrtho(0,1,0,1,-1,2)
            glMatrixMode(GL_MODELVIEW)
            glLoadIdentity()
            
            glColor4f(1.0,1.0,1.0,0.5)
            nx = vhone.data.imax
            pts = np.zeros((nx,2),dtype="float64")
            #import pdb; pdb.set_trace()
            pts[:,0] = np.arange(0,1.0,1.0/float(nx))
            pts[:,1] = vhone.data.zro[0:nx,0,0]
            #print "rho MAX/MIN:", vhone.data.zro.min(),vhone.data.zro.max()
            #print "P MAX/MIN:", vhone.data.zpr.min(),vhone.data.zpr.max()
            #pts = rampy.data.xp
            print pts.dtype, vhone.data.zro.dtype
            pts = pts.flatten()
            self._glPoints = (GLdouble * len(pts))(*pts)
            
            glEnableClientState(GL_VERTEX_ARRAY)
            glVertexPointer(2, GL_DOUBLE, 0, self._glPoints)
            glDrawArrays(GL_POINTS,0,len(pts)//2)
            
        @self._window.event
        def on_mouse_drag(x, y, dx, dy, buttons, modifiers):
            w, h = self._window.get_size()
            x = x/float(w)
            y = y/float(h)
            mx, my = self._mx, self._my
            if x >= 1.0:
                return
            if x <= 0.0:
                return
            if y >= 1.0:
                return
            if y <= 0.0:
                return
            self._mx = x
            self._my = y
            self._step = buttons == 1
            
        @self._window.event
        def on_mouse_release(x, y, button, modifiers):
            self._step = False
            
        # Initialise sim data
        vhone.data.imax = 100
        vhone.data.setup()
        # Set up rendering
        s = 0.02
        #glOrtho(-s,+s,-s,+s,-100*s,+100*s)
        glEnable(GL_BLEND)
        glPointSize(2)
        # Set up pyglet to run
        pyglet.clock.set_fps_limit(60)
        pyglet.clock.schedule_interval(self.Step,1.0/60.0)
        pyglet.app.run()
        
    def Step(self, dt):
        if self._step:
            vhone.data.step()
        


if __name__=="__main__":
    int = Integrator()
    int.Setup()
    
